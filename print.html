<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>طباعة نصوص سريعة</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        .card { border: 2px solid #27ae60; padding: 20px; border-radius: 15px; max-width: 350px; margin: auto; }
        input { width: 80%; padding: 12px; margin: 10px; font-size: 18px; text-align: center; }
        button { width: 90%; padding: 15px; margin: 5px; font-size: 18px; cursor: pointer; border-radius: 10px; border: none; font-weight: bold; }
        .btn-connect { background: #007bff; color: white; }
        .btn-print { background: #28a745; color: white; }
    </style>
</head>
<body>

<div class="card">
    <h3>طباعة باركود (نظام الأوامر السريع)</h3>
    <button class="btn-connect" onclick="connect()">1. ربط الطابعة</button>
    <hr>
    <input type="number" id="pCode" placeholder="كود المنتج">
    <input type="number" id="pWeight" placeholder="الوزن">
    <button class="btn-print" onclick="printTextOnly()">2. طباعة فورية ⚡</button>
</div>

<script>
    let printerChar = null;

    async function connect() {
        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'SC03' }],
                optionalServices: ['0000ae30-0000-1000-8000-00805f9b34fb']
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService('0000ae30-0000-1000-8000-00805f9b34fb');
            printerChar = await service.getCharacteristic('0000ae01-0000-1000-8000-00805f9b34fb');
            alert("تم الربط بنجاح! ✅");
        } catch (e) { alert("خطأ: " + e); }
    }

    async function printTextOnly() {
        if (!printerChar) return alert("اربط الطابعة أولاً!");

        const code = document.getElementById('pCode').value.padStart(5, '0');
        const weight = document.getElementById('pWeight').value.padStart(5, '0');
        const barcodeValue = "21" + code + weight + "0";

        const encoder = new TextEncoder();
        
        // أوامر ESC/POS: ترسل أرقاماً بسيطة جداً بدلاً من الصور
        const cmds = [
            new Uint8Array([0x1B, 0x40]), // تهيئة الطابعة
            new Uint8Array([0x1B, 0x61, 0x01]), // توسيط الطباعة
            encoder.encode("\n" + barcodeValue + "\n"), // طباعة الرقم كنص عادي
            new Uint8Array([0x1D, 0x6B, 0x49, 13, 0x7B, 0x41]), // أمر بدء باركود Code128
            encoder.encode(barcodeValue), // بيانات الباركود
            new Uint8Array([0x0A, 0x0A, 0x0A, 0x0A]) // تغذية ورق للخروج
        ];

        try {
            for (let cmd of cmds) {
                await printerChar.writeValue(cmd);
            }
        } catch (e) { 
            console.log("حدث خطأ، نحاول التقطيع...");
            // إذا فشل الإرسال المباشر، نقسم النص لقطع صغيرة جداً
            for (let cmd of cmds) {
                for (let i = 0; i < cmd.length; i += 20) {
                    await printerChar.writeValue(cmd.slice(i, i + 20));
                }
            }
        }
    }
</script>
</body>
</html>
