<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø·Ø¨Ø§Ø¹Ø© Ø³Ø±ÙŠØ¹Ø©</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        .card { border: 2px solid #007bff; padding: 20px; border-radius: 15px; max-width: 350px; margin: auto; }
        input { width: 80%; padding: 10px; margin: 10px; font-size: 18px; border-radius: 5px; border: 1px solid #ccc; }
        button { width: 90%; padding: 15px; margin: 5px; font-size: 18px; cursor: pointer; border-radius: 10px; border: none; font-weight: bold; }
        .btn-connect { background: #007bff; color: white; }
        .btn-print { background: #28a745; color: white; }
    </style>
</head>
<body>

<div class="card">
    <h3>Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3>
    <button class="btn-connect" onclick="connectDevice()">1. Ø±Ø¨Ø· Ø§Ù„Ø·Ø§Ø¨Ø¹Ø©</button>
    <hr>
    <input type="number" id="pCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬">
    <input type="number" id="pWeight" placeholder="Ø§Ù„ÙˆØ²Ù†">
    <button class="btn-print" onclick="printDirect()">2. Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¢Ù† ğŸ–¨ï¸</button>
    <canvas id="canvas" style="display:none;"></canvas>
</div>

<script>
    let deviceChar = null;

    async function connectDevice() {
        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'SC03' }],
                optionalServices: ['0000ae30-0000-1000-8000-00805f9b34fb']
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService('0000ae30-0000-1000-8000-00805f9b34fb');
            deviceChar = await service.getCharacteristic('0000ae01-0000-1000-8000-00805f9b34fb');
            alert("ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­! âœ…");
        } catch (e) { alert("ÙØ´Ù„ Ø§Ù„Ø±Ø¨Ø·: " + e); }
    }

    async function printDirect() {
        if (!deviceChar) return alert("Ø§Ø±Ø¨Ø· Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© Ø£ÙˆÙ„Ø§Ù‹!");

        const val = "21" + document.getElementById('pCode').value.padStart(5, '0') + 
                    document.getElementById('pWeight').value.padStart(5, '0') + "0";

        // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
        const canvas = document.getElementById('canvas');
        JsBarcode(canvas, val, { format: "CODE128", height: 60, width: 2 });
        
        const ctx = canvas.getContext('2d');
        const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ø§Ø¨Ø¹Ø©
        const wBytes = Math.ceil(img.width / 8);
        const data = new Uint8Array(wBytes * img.height);
        for (let y = 0; y < img.height; y++) {
            for (let x = 0; x < img.width; x++) {
                const idx = (y * img.width + x) * 4;
                if (img.data[idx] < 128) data[y * wBytes + Math.floor(x/8)] |= (0x80 >> (x % 8));
            }
        }

        try {
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± (Ù…Ù‚Ø·Ø¹Ø© Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ 512 Ø¨Ø§ÙŠØª)
            await send(new Uint8Array([0x1B, 0x40, 0x1B, 0x61, 0x01])); // ØªÙ‡ÙŠØ¦Ø© ÙˆØªÙˆØ³ÙŠØ·
            await send(new Uint8Array([0x1D, 0x76, 0x30, 0x00, wBytes, 0x00, img.height, 0x00])); // Ø±Ø£Ø³ Ø§Ù„ØµÙˆØ±Ø©
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØ±Ø© Ù‚Ø·Ø¹Ø§Ù‹
            for (let i = 0; i < data.length; i += 100) {
                await deviceChar.writeValue(data.slice(i, i + 100));
            }

            await send(new Uint8Array([0x0A, 0x0A, 0x0A])); // ØªØºØ°ÙŠØ© ÙˆØ±Ù‚
        } catch (e) { alert("Ø®Ø·Ø£ Ø·Ø¨Ø§Ø¹Ø©: " + e); }
    }

    async function send(d) { await deviceChar.writeValue(d); }
</script>
</body>
</html>
